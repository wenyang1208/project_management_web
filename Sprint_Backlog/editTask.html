<!DOCTYPE html>
<html>
<head>
  <title>Task</title>
  <link rel="stylesheet" href="edittask.css">
</head>
<body>

  <div class="white-frame">
      <div class="previous-page" id="previous-page">
        <img src="../Product_Backlog/previouspage.png" width=30px height = 30px>
      </div>
      <div class="menu-bar">
        <button id="menu-button"><img src="../Product_Backlog/menubar.png" width=30px height=20px></button>
        <div class="menu-items" id="menu-items">
          <a href="../Product_Backlog/prodBacklog.html">Product backlog</a>
          <a href="../Sprint_Backlog/scrumboard.html">Scrumboard</a>
          <a href="#">Team management</a>
          <a href="#">Profile</a>
          <a href="#">Reset password</a>
          <a href="#">Log out</a>
        </div>
      </div>

    <div class="task-frame flex col">
      <div class="task-name" id="task-name">Task name</div>
      <div class="taskview">
        <div class="flex col">
          <div class="assignee">
            <span class="text">Assignee: </span>
            <select name="team-member" id="AssigneeList">
              <option value="Alice">Alice</option>
              <option value="Bob">Bob</option>
              <option value="Larry">Larry</option>
              <option value="Zam">Zam</option>
              </select>
          </div>
          <div class="priority">
            <span class="text">Priority: </span>
            <select name="priority" id="priorities">
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="Important">Important</option>
                <option value="Urgent">Urgent</option>
              </select>
          </div>
          <div class="stage-of-task">
            <span class="text">Stage of task: </span>
            <select name="Stage-of-task" id="SOT">
                <option value="Planning">Planning</option>
                <option value="Development">Development</option>
                <option value="Testing">Testing</option>
                <option value="Integration">Integration</option>
              </select>
          </div>
        </div>
        <div class="flex col">
          <div class="story-points">
            <span class="text">Story Points: </span>
            <button class="decrement-button" id="decrement">-</button>
            <input type="number" class="input-field" id="storyPoints" value="1" min="1" max="10" disabled>
            <button class="increment-button" id="increment">+</button>
          </div>
          <div class="status">
            <span class="text">Status: </span>
            <input type="radio" id="Not Started" name="status" value="Not Started">
            <label for="Not Started"> Not Started </label>
            <input type="radio" id="In Progress" name="status" value="In Progress">
            <label for="In Progress"> In Progress </label>
            <input type="radio" id="Completed" name="status" value="Completed">
            <label for="Completed"> Completed</label>
          </div>
          <div class="category">
            <span class="text">Category: </span>
            <input type="radio" id="Story" name="category" value="Story">
            <label for="Story"> Story </label>
            <input type="radio" id="Bug" name="category" value="Bug">
            <label for="Bug"> Bug </label>
          </div>
        </div>
          <div class="tags-container">
            <div class="tags tags1" id="FE"></div>
            <div class="tags tags2" id="BE"></div>
            <div class="tags tags3" id="API"></div>
            <div class="tags tags4" id="DB"></div>
            <div class="tags tags5" id="FW"></div>
            <div class="tags tags6" id="TEST"></div>
            <div class="tags tags7" id="UI"></div>
            <div class="tags tags8" id="UX"></div>

          </div>
      </div>
      <div class="task-description">
        <div class="text">Task description:</div>
        <textarea rows="8" columns="50" class="description text" id="task-description" value="..."></textarea>
      </div>
      <div class="accumulatetime">
        
        <div class="log-time-spent">
          <div class="text">Log time spent:</div>
        </div>

        <div class="table-button-container">
          <div class="table-container">
            <div class="tablebg">
              <table style="display: block;">
                <tr>
                  <td>Date</td>
                  <td><input type="date" id="date-time-spent"></td>
                </tr>
                <tr>
                  <td>Start</td>
                  <td><input type="time" id="start-time-spent"></td>
                </tr>
                <tr>
                  <td>End</td>
                  <td><input type="time" id="end-time-spent"></td>
                </tr>
              </table>
            </div>
            
            <div class="add-button-container">
              <div id="add-button" class="add-button">Add</div>
            </div>
          </div>  
        </div>

        <br>

        <div class="taskview">
          <div class="accumulationtime">
            <span class="text">Accumulation of time: </span>
            <span class="text" id="accumulation-time"></span>
            <span class="text"> hrs</span>
          </div>
        </div>

      </div>
    </div>
    </div>

 
    <br>
    <div class="button-container">
        <a href="task.html" id="save-button" class="save-button">save</a>
        <div class="tag-bar" id="tag-bar">
            <div class="tag-menu" id="tag-menu">
                <label class="tag1" for="FEoption"><input type="checkbox" id="FEoption" name="tag" value="Frontend">Frontend</label>
                <label class="tag2" for="BEoption"><input type="checkbox" id="BEoption" name="tag" value="Backend">Backend</label>
                <label class="tag3" for="APIoption"><input type="checkbox" id="APIoption" name="tag" value="API">API</label>
                <label class="tag4" for="DBoption"><input type="checkbox" id="DBoption" name="tag" value="Database">Database</label>
                <label class="tag5" for="FWoption"><input type="checkbox" id="FWoption" name="tag" value="Framework">Framework</label>
                <label class="tag6" for="TESToption"><input type="checkbox" id="TESToption" name="tag" value="Testing">Testing</label>
                <label class="tag7" for="UIoption"><input type="checkbox" id="UIoption" name="tag" value="UI">UI</label>
                <label class="tag8" for="UXoption"><input type="checkbox" id="UXoption" name="tag" value="UX">UX</label>
            </div>
            <div class="tag-button" id="tag-button">Tag</div>
        </div>
        <div id="delete-button" class="delete-button">Delete</div>
    </div>
    

  </div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref, set, get, child, query, update,push } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
const firebaseConfig = {
    apiKey: "AIzaSyAk2H_8opCo31ebK1Ce_hZ5G36XNkydR1s",
    authDomain: "project-2782373696466964042.firebaseapp.com",
    databaseURL: "https://project-2782373696466964042-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "project-2782373696466964042",
    storageBucket: "project-2782373696466964042.appspot.com",
    messagingSenderId: "971400388443",
    appId: "1:971400388443:web:fc495758d4109f4a1f847e"
};

const 
  FEoption = document.getElementById("FEoption"),
  BEoption = document.getElementById("BEoption"),
  APIoption = document.getElementById("APIoption"),
  DBoption = document.getElementById("DBoption"),
  FWoption = document.getElementById("FWoption"),
  TESToption = document.getElementById("TESToption"),
  UIoption = document.getElementById("UIoption"),
  UXoption = document.getElementById("UXoption"),
  tagOptionList = [FEoption,BEoption,APIoption,DBoption,FWoption,TESToption,UIoption,UXoption],
  FE = document.getElementById("FE"),
  BE = document.getElementById("BE"),
  API = document.getElementById("API"),
  DB = document.getElementById("DB"),
  FW = document.getElementById("FW"),
  TEST = document.getElementById("TEST"),
  UI = document.getElementById("UI"),
  UX = document.getElementById("UX"),
  increment = document.getElementById("increment"),
  decrement = document.getElementById("decrement"),
  tagDisplayList = [FE,BE,API,DB,FW,TEST,UI,UX],
  urlParams = new URLSearchParams(window.location.search),
  sprintId = urlParams.get("sprintId"),
  taskId = urlParams.get("taskId"),
  previousPage = document.getElementById("previous-page")
  const taskNameElement = document.getElementById("task-name");
const taskDescriptionElement = document.getElementById("task-description");
const taskPriorityElement = document.getElementById("priorities");
const storyPointsElement = document.getElementById("storyPoints");
const taskAssigneeElement = document.getElementById("AssigneeList");
const taskStageElement = document.getElementById("SOT");
const notStarted = document.getElementById("Not Started"),
  inProgress = document.getElementById("In Progress"),
  completed = document.getElementById("Completed"),
  story = document.getElementById("Story"),
  bug = document.getElementById("Bug")
const deletebutton = document.getElementById("delete-button")
const savebutton = document.getElementById("save-button");
const addbutton = document.getElementById("add-button");
const accTime = document.getElementById("accumulation-time");

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  let tags = ["Frontend","Backend","API","Database","Framework","Testing","UI","UX"]

document.addEventListener("DOMContentLoaded", function () {
  const dataRef = ref(db, `newsprint/${sprintId}/selectedTasks/${taskId}`);
  const savedTasks = []
  var task = {}

    get(dataRef).then((snapshot) => {
        if (snapshot.exists()) {
            console.log(snapshot.val())
            console.log(Object.keys(snapshot.val()))
            const data = snapshot.val()
            task = data
            console.log(task)
            snapshot.forEach((childSnapshot) => {
                const childData = childSnapshot.val();
                savedTasks.push(childData)
            });
    }}
    )
    .then(()=> console.log(savedTasks))
    .then(()=> displayTaskDetails(task));

//----------------------------------------------display task detail------------------------------------------------------------------
function displayTaskDetails(savedTasks){
    if (taskId !== null && taskId.length >= 0) {
        const task = {
            "dateAdded": savedTasks["dateAdded"],
            "taskAssignee": savedTasks["taskAssignee"],
            "taskCategory": savedTasks["taskCategory"],
            "taskDescription": savedTasks["taskDescription"],
            "taskName": savedTasks["taskName"],
            "taskPriority": savedTasks["taskPriority"],
            "taskStage": savedTasks["taskStage"],
            "taskStatus": savedTasks["taskStatus"],
            "taskStoryPoints": savedTasks["taskStoryPoints"],
            "taskTags": savedTasks["taskTags"],
            "accumulationOfTime":savedTasks["accumulationOfTime"]
        } 
        taskNameElement.textContent = task["taskName"];
        taskDescriptionElement.textContent = task["taskDescription"];
        taskPriorityElement.value = task["taskPriority"];
        storyPointsElement.value = task["taskStoryPoints"];
        taskStageElement.value = task["taskStage"];
        taskAssigneeElement.value = task["taskAssignee"];
        accTime.textContent = task["accumulationOfTime"]
        if (task["taskStatus"] == "Not Started"){
          notStarted.checked = true
        }
        else if (task["taskStatus"] == "In Progress"){
          inProgress.checked = true
        }
        else if (task["taskStatus"] == "Completed"){
          completed.checked=true
        }
        if (task["taskCategory"] == "Story"){
          story.checked = true
        }
        else if (task["taskCategory"] == "Bug"){
          bug.checked = true
        }
        try{
            task["taskTags"].forEach((taskTag)=>{
                if (taskTag == null){
                  return;
                }
                else {
                  const tagsPair = ['Frontend','Backend', 'API','Database','Framework','Testing','UI','UX']
                    if (tagsPair.includes(taskTag)){
                      tagDisplayList[tagsPair.indexOf(taskTag)].style.display = "block";
                      tagOptionList[tagsPair.indexOf(taskTag)].checked = true
                          }
                      };   
      
                        })
                    
                
              
        }catch{console.log("Empty")}
    } else {
        taskNameElement.textContent = "Task not found.";
    }
}

const logTimeSpentArray = []
 addbutton.addEventListener("click",function(){
  const date1 = document.getElementById("date-time-spent")
   console.log(date1.value);
   const startTime = document.getElementById("start-time-spent");
   const endTime = document.getElementById("end-time-spent");
   const timeSpent1 = parseFloat(endTime.value) - parseFloat(startTime.value);
   if (timeSpent1 >= 0){
   const logTimeSpent = {
    date: date1.value,
    timeSpent: timeSpent1
   }
   logTimeSpentArray.push(logTimeSpent)
   accTime.textContent = parseFloat(accTime.textContent) + timeSpent1;
  }
  else{
    alert('Please enter a valid input')
  }
   date1.value = ""
   startTime.value = ""
   endTime.value = ""
 })
//--------------------------------------------------story point-----------------------------------------------------
increment.addEventListener("click",function(){
  if (storyPointsElement.value != storyPointsElement.max){
    storyPointsElement.value = (parseInt(storyPointsElement.value)+1).toString()
  }
})
decrement.addEventListener("click",function(){
  if (storyPointsElement.value != storyPointsElement.min){
    storyPointsElement.value = (parseInt(storyPointsElement.value)-1).toString()
  }
})

//--------------------------------------------------check tag function-----------------------------------------------------
function checkTag() {
  tagOptionList.forEach(tag => {
    if (tag.checked == true){
      tagDisplayList[tagOptionList.indexOf(tag)].style.display = "block"
    }
    else {
      tagDisplayList[tagOptionList.indexOf(tag)].style.display = "none"
    }
  })}
const check = setInterval(checkTag,10)

//--------------------------------------------------save button-----------------------------------------------------
savebutton.addEventListener("click",function(event){
  event.preventDefault();
  let taskTag = [];
        tagOptionList.forEach((tag) => {
            if (tag.checked){
                taskTag.push(tag.value)
            }
        })

  tags = tags.filter(tag => taskTag.includes(tag));
  const abc = ref(db, `newsprint/${sprintId}/selectedTasks/${taskId}/logTimeSpent`)
  const newLogTime = push(abc)
  logTimeSpentArray.forEach((logTimeSpent)=>{
    set(newLogTime,logTimeSpent)
  })
//--------------------------------------------------update data-----------------------------------------------------

const status = document.querySelector('input[name="status"]:checked').value
  if (status == "Completed"){
    get(ref(db, `newsprint/${sprintId}/selectedTasks/${taskId}`)).then((task)=>{
      if (task["taskStatus"] == "Completed"){
        update(ref(db, `newsprint/${sprintId}/selectedTasks/${taskId}`),
    {
      taskAssignee :document.querySelector("#AssigneeList").value,
      taskPriority :document.querySelector("#priorities").value,
      taskStage : document.querySelector("#SOT").value,
      taskStoryPoints : document.querySelector("#storyPoints").value,
      taskStatus : document.querySelector('input[name="status"]:checked').value,      
      taskCategory : document.querySelector('input[name="category"]:checked').value,
      taskDescription : document.querySelector("#task-description").value,
      taskTags : taskTag,
      accumulationOfTime: accTime.textContent
    })
      }
      else {
        const date = new Date()
    const year = date.toLocaleString('en-GB',{year:"numeric"})
    console.log(year)
    const month = date.toLocaleString('en-GB',{month:"2-digit"})
    const day = date.toLocaleString('en-GB',{day:"2-digit"})
    const date_ = [year,month,day].join("-")
    console.log(date_)
    update(ref(db, `newsprint/${sprintId}/selectedTasks/${taskId}`),
    {
      taskAssignee :document.querySelector("#AssigneeList").value,
      taskPriority :document.querySelector("#priorities").value,
      taskStage : document.querySelector("#SOT").value,
      taskStoryPoints : document.querySelector("#storyPoints").value,
      taskStatus : document.querySelector('input[name="status"]:checked').value,      
      taskCategory : document.querySelector('input[name="category"]:checked').value,
      taskDescription : document.querySelector("#task-description").value,
      taskTags : taskTag,
      accumulationOfTime: accTime.textContent,
      dateCompleted: date_
    })
      }
    }).then(() => { window.location.href = `task.html?sprintId=${sprintId}&taskId=${taskId}`});

  }
  else {
    update(ref(db, `newsprint/${sprintId}/selectedTasks/${taskId}`),
    {
      taskAssignee :document.querySelector("#AssigneeList").value,
      taskPriority :document.querySelector("#priorities").value,
      taskStage : document.querySelector("#SOT").value,
      taskStoryPoints : document.querySelector("#storyPoints").value,
      taskStatus : document.querySelector('input[name="status"]:checked').value,      
      taskCategory : document.querySelector('input[name="category"]:checked').value,
      taskDescription : document.querySelector("#task-description").value,
      taskTags : taskTag,
      accumulationOfTime: accTime.textContent
    }).then(() => { window.location.href = `task.html?sprintId=${sprintId}&taskId=${taskId}`});
  }

    //.then(() => { window.location.href = `task.html?sprintId=${sprintId}&taskId=${taskId}`});

})
previousPage.addEventListener("click",function(){
  window.location.href = `task.html?sprintId=${sprintId}&taskId=${taskId}`
})
}
);
</script>
</body>
</html>