<!DOCTYPE html>
<html>
<head>
  <title>Task</title>
  <link rel="stylesheet" href="task.css">
</head>
<body>

  <div class="white-frame">
      <div class="previous-page">
        <div class = "previous-button" id = "previous-button"><img src="../Product_Backlog/previouspage.png" width=30px height = 30px></div>
      </div>
      <div class="menu-bar">
        <button id="menu-button"><img src="../Product_Backlog/menubar.png" width=30px height=20px></button>
        <div class="menu-items" id="menu-items">
          <a href="../Product_Backlog/prodBacklog.html">Product backlog</a>
          <a href="scrumboard.html">Scrumboard</a>
          <a href="#">Team management</a>
          <a href="../Team_management/profilepage.html">Profile</a>
          <a href="#">Reset password</a>
          <a href="#">Log out</a>
        </div>
      </div>

    <div class="task-frame flex col">
      <!-- <div class="taskName"></div> -->
      <h1 id="taskNameHeader"></h1>

      <div class="taskview">
        <div class="flex col">
          <!-- <div class="assignee">
            <span class="text">Assignee: </span>
            <span class="text" id="Assignee">...</span>
          </div> -->
          <div class="task-info">
            <span class="info-label">Assignee:</span>
            <span class="info-value" id="asignees"></span>
          </div>

          <div class="priority">
            <span class="text">Priority: </span>
            <span class="text" id="taskPriority"></span>
          </div>

          <!-- <div class="stage-of-task">
            <span class="text">Stage of task: </span>
            <span class="text" id="stages">...</span>
          </div> -->
          <div class="task-info">
            <span class="info-label">Stage of task:</span>
            <span class="text" id="stages"></span>
        </div>

          <!-- Remap description here
          <div class="task-description">
            <div class="text">Task description:</div>
            <div class="description" id="task-description"></div>
          </div>-->

        </div>

        <div class="flex col">
          <div class="story-points">
            <span class="text">Story Points: </span>
            <span class="text" id="storyPoints"></span>
          </div>

          <div class="status">
            <span class="text">Status: </span>
            <span class="text" id="status">...</span>
          </div>
          <div class="category">
            <span class="text">Task Type: </span>
            <span class="text" id="category">...</span>
          </div>

        </div>

          <div class="tags-container">
            <div class="tags tags1" id="FE">Frontend</div>
            <div class="tags tags2" id="BE">Backend</div>
            <div class="tags tags3" id="API">API</div>
            <div class="tags tags4" id="DB">Database</div>
            <div class="tags tags5" id="FW">Framework</div>
            <div class="tags tags6" id="TEST">Testing</div>
            <div class="tags tags7" id="UI">UI</div>
            <div class="tags tags8" id="UX">UX</div>
          </div>

      </div>

      
      <div class="task-description">
        <div class="text">Task description:</div>
        <textarea rows="8" columns="50" class="description text" id="task-description" value="..."></textarea>
      </div>

      <div class="taskview">
        <div class="accumulationtime">
          <span class="text">Accumulation of time: </span>
          <span class="text" id="accumulation-time"></span>
          <span class="text"> hrs</span>
        </div>
      </div>

      <div class="green-frame">
        <h2>Total Time Spent</h2>
        <canvas id="lineChart2"></canvas>
      </div>

    </div>
      <div class="button-container">
        <div id="edit-button" class="edit-button">Edit</div>
        <!-- <a href="editTask.html" id="edit-button" class="edit-button">Edit</a> -->
        <a href="sprint.html" id="delete-button" class="delete-button">Delete</a>
      </div>

 
    <br>
    

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
    //--------------------------------------------------DOWNLOAD CHART.JS-----------------------------------------------------------------------
    </script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref, set, get, child, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
const firebaseConfig = {
    apiKey: "AIzaSyAk2H_8opCo31ebK1Ce_hZ5G36XNkydR1s",
    authDomain: "project-2782373696466964042.firebaseapp.com",
    databaseURL: "https://project-2782373696466964042-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "project-2782373696466964042",
    storageBucket: "project-2782373696466964042.appspot.com",
    messagingSenderId: "971400388443",
    appId: "1:971400388443:web:fc495758d4109f4a1f847e"
};

// taskdetails.js (for taskdetails.html)
const
previousbutton = document.getElementById("previous-button"),
FE = document.getElementById("FE"),
BE = document.getElementById("BE"),
API = document.getElementById("API"),
DB = document.getElementById("DB"),
FW = document.getElementById("FW"),
TEST = document.getElementById("TEST"),
UI = document.getElementById("UI"),
UX = document.getElementById("UX"),
tagDisplayList = [FE,BE,API,DB,FW,TEST,UI,UX],
category = document.getElementById('category'),
savedTasks = []
const taskNameElement = document.getElementById("taskNameHeader");
const taskDescriptionElement = document.getElementById("task-description");
const taskPriorityElement = document.getElementById("taskPriority");
const storyPointsElement = document.getElementById("storyPoints");
const taskAssigneeElement = document.getElementById("asignees");
const taskStageElement = document.getElementById("stages");
const taskStatusElement = document.getElementById("status");
const taskTagsElement = document.getElementById("tags");
const editbutton = document.getElementById("edit-button")
const saveTaskButton = document.getElementById("saveTaskButton");
const accumulationOfTime = document.getElementById("accumulation-time")
const logTimeSpentDataArray = [];
const duration = [];
//----------------------------------------------get task id------------------------------------------------------------------
const urlParams = new URLSearchParams(window.location.search);
const sprintId = urlParams.get("sprintId");
const taskId = urlParams.get("taskId");
document.addEventListener("DOMContentLoaded", function () {
  previousbutton.addEventListener("click",function(){
    window.location.href = `sprint.html?sprintId=${sprintId}`
  })

//----------------------------------------------get data------------------------------------------------------------------
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dataRef = ref(db, `newsprint/${sprintId}/selectedTasks/${taskId}`);
    var task ={}

    get(dataRef).then((snapshot) => {
        if (snapshot.exists()) {

            const log_Time_Spent = snapshot.val()["logTimeSpent"];
            for(const ele in snapshot.val()["logTimeSpent"]){
              logTimeSpentDataArray.push(log_Time_Spent[ele])
            }

            get(ref(db,`newsprint/${sprintId}`)).then((sprint)=> {
            var[startYear,startMonth,startDay] = sprint.val()["startDate"].split("-");
            var[endYear,endMonth,endDay] = sprint.val()["endDate"].split("-");
            startYear = parseInt(startYear)
            startMonth = parseInt(startMonth)
            startDay = parseInt(startDay)
            endYear = parseInt(endYear)
            endMonth = parseInt(endMonth)
            endDay = parseInt(endDay)
            if (startYear==endYear){
              if (startMonth == endMonth){
                for (let day = startDay; day<=endDay; day++){
                  const dateString = [startYear, startMonth, day].join("-")
                  duration.push(dateString)
                }
              }
          }}
          )
          .then(()=>{            
            console.log(snapshot.val())
            task = snapshot.val()
            snapshot.forEach((childSnapshot) => {
                const childData = childSnapshot.val();
                savedTasks.push(childData)
                displayTaskDetails(task)
            });})
    }}
    )

//----------------------------------------------display task detail------------------------------------------------------------------
function displayTaskDetails(savedTasks){
    if (taskId !== null && taskId.length >= 0) {
        const task = {
          "dateAdded": savedTasks["dateAdded"],
            "taskAssignee": savedTasks["taskAssignee"],
            "taskCategory": savedTasks["taskCategory"],
            "taskDescription": savedTasks["taskDescription"],
            "taskName": savedTasks["taskName"],
            "taskPriority": savedTasks["taskPriority"],
            "taskStage": savedTasks["taskStage"],
            "taskStatus": savedTasks["taskStatus"],
            "taskStoryPoints": savedTasks["taskStoryPoints"],
            "taskTags": savedTasks["taskTags"],
            "accumulationOfTime":savedTasks["accumulationOfTime"]
        } 
        taskNameElement.textContent = task["taskName"];
        taskDescriptionElement.value = task["taskDescription"];
        if (task["taskPriority"] == "Low"){
          taskPriorityElement.style.color = "green";
        }
        else if (task["taskPriority"] == "Medium"){
          taskPriorityElement.style.color = "yellow"
        }
        else if (task["taskPriority"] == "Important"){
          taskPriorityElement.style.color = "orange"
        }
        else if (task["taskPriority"] == "Urgent"){
          taskPriorityElement.style.color = "red"
        }
        taskPriorityElement.textContent = task["taskPriority"];
        storyPointsElement.textContent = task["taskStoryPoints"];
        taskStageElement.textContent = task["taskStage"];
        taskAssigneeElement.textContent = task["taskAssignee"];
        taskStatusElement.textContent = task["taskStatus"];
        category.textContent = task["taskCategory"];
        accumulationOfTime.textContent=task["accumulationOfTime"]
        try{
            task["taskTags"].forEach((taskTag)=>{
                if (taskTag == null){
                  return;
                }
                else {
                    for (const tag of tagDisplayList){
                        if (taskTag == tag.textContent){
                            console.log(tag.textContent)
                            tag.style.display = "block";
                            break;
                        }
                    }
                }
              })
        }catch{console.log("Empty")}
    } else {
        taskNameElement.textContent = "Task not found.";
    }

    const xValues = [];
    const yValues = [];
    const dateSet = new Set(duration);

    duration.forEach(date => {
      // Check if the date exists in logTimeSpentDataArray
      const timeData = logTimeSpentDataArray.find(time => time.date === date);

      if (timeData) {
        // If found, push the timeSpent value
        xValues.push(new Date(timeData.date));
        yValues.push(timeData.timeSpent);
      } else {
        // If not found, push 0
        xValues.push(new Date(date));
        yValues.push(0);
      }
    });

    logTimeSpentDataArray.sort((a, b) => new Date(a.date) - new Date(b.date));

    const formattedDates = xValues.map((date) => {
        const day = date.getDate().toLocaleString('en-GB',{year:"numeric"})
        const month = (date.getMonth() + 1).toLocaleString('en-GB',{month:"2-digit"})
        const year = date.getFullYear();
        return [year,month,day].join("-");
      });

    // if (formattedDates !== null){
    //   formattedDates
    // }

    var data = {
      labels: duration,
      datasets: [{
        label: "Total hour spent",
        backgroundColor:"rgba(0,0,255,1.0)",
        borderColor: "rgba(0,0,255,255)",
        data: yValues,
        fill: false,
        tension: 0
    }]
    }

    generateChart(data);
}

// ------------------------------------------ generate view chart------------------------------------------------------------------------
function generateChart(data){
      var ctx = document.getElementById('lineChart2').getContext('2d');
      var lineChart = new Chart(ctx, {
      type: 'line',
      data: data,
      options: {
    scales: {
      xAxes: [{
        scaleLabel: {
          display: true,
          labelString: 'Date' // Set the X-axis label
        }
      }],
      yAxes: [{
        scaleLabel: {
          display: true,
          labelString: 'Total Time Spent' // Set the Y-axis label
        }
      }]
    }
  }
    });}

//----------------------------------------------edit button------------------------------------------------------------------

    editbutton.addEventListener("click",function(event){
        event.preventDefault()
        window.location.href=`edittask.html?sprintId=${sprintId}&taskId=${taskId}`
    })
});
</script>
</body>
</html>
