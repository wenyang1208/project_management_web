<!DOCTYPE html>
<html>
<head>
<title>Profile page</title>
<link rel="stylesheet" href="deletemember.css">
</head>
<body>
<div class="onoffbutton">
<label class="switch">
  <input type="checkbox" id="toggleButton">
  <span class="slider round"></span>
</label>
</div>
<div class="white-frame"> 
<div class="header-menu-container">
<div class="previous-page" id="previous-page">
<a><img src="../Product_Backlog/previouspage.png" width=30px height = 30px></a>
</div>
<div class="menu-bar">
<button id="menu-button"><img src="../Product_Backlog/menubar.png" width=30px height=20px></button>
<div class="menu-items" id="menu-items">
    <a id="prodBacklog" style="cursor: pointer;">Product backlog</a>
    <a id="scrumboard" style="cursor: pointer;">Scrumboard</a>
    <a id="teamManagement" style="cursor: pointer;">Team management</a>
    <a id="profile" style="cursor: pointer;">Profile</a>
    <a id="resetpassword" style="cursor: pointer;">Reset password</a>
    <a id="LogOutButton" style="cursor: pointer;">Log out</a>
</div>
</div>
</div>

<div class="dark-blue-frame">
    <div class="teammember">
        Team Member
    </div>
    <div class="email">
        Email
    </div>
</div>

<div class="details-frame">
    <div class="details-container">
        <div class="checkbox">
          <input type="checkbox" class="member-checkbox" data-username="Alice">
        </div>
        <div class="name-input">
            Alice
        </div>
        <div class="email-input">
            alice@gmail.com
        </div>
    </div>
</div>

<div class="details-frame">
    <div class="details-container">
        <div class="checkbox">
            <input type="checkbox" class="member-checkbox" data-username="Bob">
        </div>
        <div class="name-input">
            Bob
        </div>
        <div class="email-input">
            bob@gmail.com
        </div>
    </div>
</div>

<div class="details-frame">
    <div class="details-container">
        <div class="checkbox">
            <input type="checkbox" class="member-checkbox" data-username="Fred">
        </div>
        <div class="name-input">
            Fred
        </div>
        <div class="email-input">
            fred@gmail.com
        </div>
    </div>
</div>


<div class="button-container">
    <a style="cursor: pointer;" id="delete-button" class="delete-button">Delete</a>
    <a style="cursor: pointer;" id="discard-button" class="discard-button">Discard</a>
</div>

</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, query, orderByChild,remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    const toggleButton = document.getElementById("toggleButton");
    const body = document.body;
  
    toggleButton.addEventListener("change", function() {
      if (toggleButton.checked) {
        body.classList.add("color-blind-friendly");
      } else {
        body.classList.remove("color-blind-friendly");
      }
    });

    const firebaseConfig = {
        apiKey: "AIzaSyAk2H_8opCo31ebK1Ce_hZ5G36XNkydR1s",
        authDomain: "project-2782373696466964042.firebaseapp.com",
        databaseURL: "https://project-2782373696466964042-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "project-2782373696466964042",
        storageBucket: "project-2782373696466964042.appspot.com",
        messagingSenderId: "971400388443",
        appId: "1:971400388443:web:fc495758d4109f4a1f847e"
    };

    document.addEventListener("DOMContentLoaded", function () {
        // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const urlParams = new URLSearchParams(window.location.search)
    const username = urlParams.get("username")
    get(ref(db,`addMember`)).then((allmember)=>{
        if (allmember.exists()){
            const allmembersName = Object.keys(allmember.val())
            console.log(allmembersName)
            
        }
    })

    const que = query(ref(db, "addMember/"));
    const memberDetails = document.querySelector('.details-frame');
    const allMemberDetails = [];

    get(que).then((snapshot) => {
      if (snapshot.exists()){
        snapshot.forEach((childSnapshot) => {
          const allMembers = snapshot.val();
          allMemberDetails.push(allMembers)
        });
      }
    })
    .then(() => {console.log(allMemberDetails)})
    .then(() => {createMemberElement(savedMemberDetails)})
    .catch((error) => {
        console.error("Error getting data:", error);
    });

    function displayMemberDetail(memberData) {
        memberDetails.innerHTML = "";
        memberData.forEach(function (member, index) {

            const detailsFrame = document.createElement("div");
            detailsFrame.classList.add("details-frame");
            
            const memberDetails = document.createElement("div");
            memberDetails.className = "details-container";

            const memberCheckbox = document.createElement("div");
            memberCheckbox.innerHTML = `<input type="checkbox" class="member-checkbox" data-username="${username}">`;

            const nameInput = document.createElement("div");
            nameInput.classList.add("name-input");
            nameInput.textContent = member.username;
            detailsFrame.appendChild(nameInput);

            const emailInput = document.createElement("div");
            emailInput.classList.add("email-input");
            emailInput.textContent = member.email;
            detailsFrame.appendChild(emailInput);

        });

    return memberData;
    }

    document.getElementById("previous-page").addEventListener("click",function(){
      window.location.href = `profilepage.html?username=${username}`
    })
    document.getElementById("discard-button").addEventListener("click",function(){
      window.location.href = `profilepage.html?username=${username}`
    })
    document.getElementById("prodBacklog").addEventListener("click",function(){
      window.location.href= `../Product_Backlog/prodBacklog.html?username=${username}`})
    
    document.getElementById("scrumboard").addEventListener("click",function(){
      window.location.href= `../Sprint_Backlog/scrumboard.html?username=${username}`})
    
    document.getElementById("teamManagement").addEventListener("click",function(){
      get(ref(db,`addMember/${username}`)).then((user)=>{
      if (user.val()["identity"] != "admin")
      {
        alert("You don't have the access to view the Team_Management")
      }
      else
      {window.location.href= `../Team_management/contributionchart.html?username=${username}`}
    })})
    document.getElementById("profile").addEventListener("click",function(){
      get(ref(db,`addMember/${username}`)).then((user)=>{
      if (user.val()["identity"] != "admin")
      {
        alert("You don't have the access to view the members' profile")
      }
      else
      {window.location.href= `../Team_management/profilepage.html?username=${username}`}})})
    document.getElementById("resetpassword").addEventListener("click",function(){
      window.location.href= `../Team_management/resetpassword.html?username=${username}`})
    
    get(ref(db,`addMember/${username}`)).then((user)=>{
        if (!user.exists()){
        window.location.href = `../Login/login.html`
      }
      else if (user.val()["status"] != "Log in"){
        window.location.href = `../Login/login.html`
      }
      else if (user.val()["identity"] != "admin"){
        alert("You have no access to view the members' profile")
        window.location.href = `../Product_Backlog/prodBacklog.html?username=${username}`
      }
    })
    document.getElementById("LogOutButton").addEventListener("click",function(){
      update((ref(db,`addMember/${username}`)),{
        status: "Log out"
      })
      window.location.href = `../Login/login.html`
    })
    });

    document.getElementById("delete-button").addEventListener("click", function(e){
      const memberCheckboxes = document.querySelectorAll(".member-checkbox:checked");

      if (memberCheckboxes.length === 0) {
        alert("Please select at least one member to delete");
      } else{
        if (confirm("Are you sure you want to delete tje selected memebrs?")){
          memberCheckboxes.forEach(function (checkbox){
            const memberToDelete = checkbox.getAttribute("data-username");
            deleteMember(memberToDelete);
            checkbox.closest("details-container").remove();
          });
        }
      }
    })

    function deleteMember(username) {
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const memberRef = ref(db, `addMember/${username}`);
      remove(memberRef)
      .then(() => {
        console.log(`Selected member has been deleted.`);
      })
      .catch((error) => {
        console.error("Error occured")
      })
    }


  </script>
</body>
</html>